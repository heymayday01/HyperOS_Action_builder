name: build_haydn_hos_1drv
on:
  workflow_dispatch:
    inputs:
      STOCK_URL:
        description: 'URL for base package'
        required: true
      PORT_URL:
        description: 'URL for port package'
        required: true

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: 1. Maximize build environment
        run: |
          # Adjust swap size
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
          # Remove unnecessary tools
          sudo apt-get remove -y --purge unattended-upgrades
      - name: 2. Clone repository
        run: |
          git clone --depth 1 https://github.com/tosasitill/HyperOS_Action_builder hyperos_port
          aria2c -s 10 -x 10 -o devices.zip -d ./hyperos_port "${{ secrets.LINK }}"
          cd hyperos_port
          mkdir devices
          cd devices
          7z x ../devices.zip
          cd ..
          rm -rf devices.zip
      - name: 3. Start porting
        run: |
          cd hyperos_port
          sudo bash port.sh "${{ github.event.inputs.STOCK_URL }}" "${{ github.event.inputs.PORT_URL }}" | tee HyperOS_portlog.log
      - name: 5. Publish release
        uses: ncipollo/release-action@v1.12.0
        with:
          artifacts: "/home/runner/work/HyperOS_Action_builder/HyperOS_Action_builder/hyperos_port/HyperOS_portlog.log"
          bodyfile: "${{ github.workspace }}/info.md"
          tag: "OUTPUT_${{ env.BUILD_TIME }}_${{ github.run_id }}"
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: 5. Upload port log
        uses: actions/upload-artifact@v4
        with:
          name: HyperOS-PortLOG
          path: "/home/runner/work/HyperOS_Action_builder/HyperOS_Action_builder/hyperos_port/HyperOS_portlog.log"
          compression-level: 9
